<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>로그인 - 학교 웹사이트</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <style>
      body {
        font-family: "Malgun Gothic", sans-serif;
        text-align: center;
        padding: 50px;
      }
      button {
        padding: 15px 30px;
        font-size: 16px;
        cursor: pointer;
        margin-top: 20px;
      }
      #message {
        margin-top: 20px;
        color: #666;
      }
      .success-box {
        background: #f0f8ff;
        padding: 20px;
        border-radius: 10px;
        margin: 20px 0;
      }
    </style>
  </head>
  <body>
    <h1>학교 웹사이트 로그인</h1>
    <p>Google 계정으로 로그인해 주세요.</p>
    <button onclick="signInWithGoogle()">Google로 로그인</button>
    <div id="message"></div>

    <script>
      // Firebase 구성 정보
      const firebaseConfig = {
        apiKey: "AIzaSyAYPVS5aoZLtjJW966Z6b60y75fSJgiTow",
        authDomain: "jeohyeonweb.firebaseapp.com",
        projectId: "jeohyeonweb",
        storageBucket: "jeohyeonweb.firebasestorage.app",
        messagingSenderId: "865403260673",
        appId: "1:865403260673:web:ec6c31ba874bf1787dd500",
        measurementId: "G-2ZB61M9ETS",
      };

      // Firebase 초기화
      firebase.initializeApp(firebaseConfig);
      const auth = firebase.auth();
      firebase.auth().setPersistence(firebase.auth.Auth.Persistence.SESSION);

      // ✅ 단일 함수로 통합
      function signInWithGoogle() {
        const provider = new firebase.auth.GoogleAuthProvider();
        provider.setCustomParameters({
          hd: "jeohyeon.hs.kr",
        });

        document.getElementById("message").textContent = "로그인 중...";

        auth
          .signInWithPopup(provider)
          .then((result) => {
            return result.user.getIdToken();
          })
          .then((idToken) => {
            // ✅ 자동 리다이렉트 로직 개선
            const streamlitAppUrl = "https://jeohyeongoweb.streamlit.app/";

            // 먼저 메시지 전송 시도 (팝업인 경우)
            if (window.opener) {
              window.opener.postMessage(
                {
                  type: "FIREBASE_ID_TOKEN",
                  token: idToken,
                },
                "*"
              );
            }

            // ✅ 3초 후 자동으로 Streamlit 앱으로 리다이렉트
            document.getElementById("message").innerHTML = `
                        <div class="success-box">
                            <h3>✅ 로그인 성공!</h3>
                            <p>3초 후 자동으로 이동합니다...</p>
                            <p>자동 이동이 안될 경우:</p>
                            <button onclick="redirectToStreamlit('${idToken}')" 
                                    style="padding: 10px 20px; background: #4285f4; color: white; border: none; border-radius: 5px; cursor: pointer; margin: 5px;">
                                바로 이동하기
                            </button>
                            <button onclick="copyToken('${idToken}')" 
                                    style="padding: 10px 20px; background: #34a853; color: white; border: none; border-radius: 5px; cursor: pointer; margin: 5px;">
                                토큰 복사하기
                            </button>
                        </div>
                    `;

            // 3초 후 자동 리다이렉트
            setTimeout(() => {
              redirectToStreamlit(idToken);
            }, 3000);
          })
          .catch((error) => {
            console.error("로그인 오류:", error);
            document.getElementById("message").innerHTML = `
                        <div style="background: #ffebee; padding: 20px; border-radius: 10px; margin: 20px 0;">
                            <h3>❌ 로그인 실패</h3>
                            <p>오류: ${error.message}</p>
                            <button onclick="location.reload()">다시 시도하기</button>
                        </div>
                    `;
          });
      }

      // ✅ 리다이렉트 함수
      function redirectToStreamlit(token) {
        window.location.href = `https://jeohyeongoweb.streamlit.app/?token=${encodeURIComponent(
          token
        )}`;
      }

      // ✅ 토큰 복사 함수
      function copyToken(token) {
        navigator.clipboard.writeText(token).then(() => {
          alert(
            "토큰이 클립보드에 복사되었습니다! Streamlit 앱에서 수동으로 붙여넣기 하세요."
          );
        });
      }
    </script>
  </body>
</html>
